<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>bitstream.io - 1DS</title>
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
        <link rel="stylesheet" href="/theme/css/main.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="bitstream.io Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <script src="/theme/js/jquery.1.11.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">bitstream.io </a></h1>
                <nav><ul>
                    <li ><a href="/category/bookscanning.html">bookscanning</a></li>
                    <li ><a href="/category/commandline.html">commandline</a></li>
                    <li ><a href="/category/links.html">links</a></li>
                    <li ><a href="/category/ops.html">ops</a></li>
                    <li ><a href="/category/python.html">python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/adding-gphoto-support-for-the-canon-1ds.html">Adding gphoto support for the Canon 1DS</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2008-08-09T16:23:00-07:00">
                Sat 09 August 2008
        </abbr>

        <address class="vcard author">
                by <a class="url fn" href="/author/shag.html">shag</a>
        </address>
in <a href="/category/bookscanning.html">bookscanning</a>.
Tags:
<a href="/tag/gphoto.html">gphoto</a>, <a href="/tag/canon.html">canon</a>, <a href="/tag/1ds.html">1DS</a>
</footer><!-- /.post-info --><p>Canon 1Ds HackiWiki!!</p>
<h2>2007 Aug 20: Raj and I discovered some interesting stuff!!!</h2>
<div class="highlight"><pre><span></span><code><span class="mf">606527</span>  <span class="n">dest</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60a8</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>

<span class="mf">606554</span>  <span class="n">dest</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="n">ffffffff</span> <span class="n">ffffffff</span> <span class="n">ffc30000</span> <span class="mf">04</span><span class="n">bf2000</span>
 <span class="mf">8</span><span class="n">a98000e</span> <span class="mf">28000000</span> <span class="mf">000000</span><span class="n">ff</span> <span class="mf">00000000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<ul>
<li>bytes 0-3 are always(?) ffffffff</li>
<li>bytes 4-7 are always(?) ffffffff</li>
<li>bytes 8-11 are always ffc30000 -- Shag is willing to bet that this 0xffc3 is the Firewire bus address of 'WINDOZE' ...<ul>
<li>A 16-bit firewire address is divided into two parts. The top 10 bits are the bus ID and the bottom 6 are the node ID. In the case of 0xffc3, the top ten bits are 1063 (base 10), which is a special value meaning 'local bus' (<a href="http://www.linux1394.org/doc/libraw1394/intro1394.html#AEN25">reference</a>)</li>
</ul>
</li>
<li>bytes 12-15 [0x04bf2000] is the offset for the S/G list</li>
<li>byte 17 &amp; mask 0x08: if true, then apparently means 'S/G list' - "counter packet" below byte 17 is 0x90</li>
<li>byte 19 (base 10) [0xe] above is the number of entries in the "S/G list" ...</li>
</ul>
<hr>
<div class="highlight"><pre><span></span><code><span class="mf">608909</span>  <span class="n">dest</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x1c</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004bf2000</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0070</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>

<span class="mf">608951</span>  <span class="n">dest</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x1c</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0070</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">0</span><span class="n">fb00000</span> <span class="mf">0</span><span class="n">b23f050</span> <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b48d000</span>
 <span class="mf">10000000</span> <span class="mf">0</span><span class="n">afe7000</span> <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b468000</span>
 <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b449000</span> <span class="mf">20000000</span> <span class="mf">0</span><span class="n">b4ba000</span>
 <span class="mf">10000000</span> <span class="mf">0</span><span class="n">a3fc000</span> <span class="mf">10000000</span> <span class="mf">0</span><span class="n">a3dd000</span>
 <span class="mf">10000000</span> <span class="mf">0</span><span class="n">a9de000</span> <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b437000</span>
 <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b488000</span> <span class="mf">10000000</span> <span class="mf">0</span><span class="n">b461000</span>
 <span class="mf">20000000</span> <span class="mf">0</span><span class="n">a3ea000</span> <span class="mf">0</span><span class="n">f500000</span> <span class="mf">0</span><span class="n">b48e000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<p>First two bytes are length of transfer; next two bytes apparently are ignored; next four bytes is
address on WINDOZE to transfer to.  After this the JPEG data starts.</p>
<hr>
<p>These wacky packets (wackets?) are from a completely different part of the file.</p>
<div class="highlight"><pre><span></span><code><span class="mf">507816</span>  <span class="n">dest</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="n">ffffffff</span> <span class="n">ffffffff</span> <span class="n">ffc30000</span> <span class="mf">172</span><span class="n">e6380</span>
 <span class="mf">8</span><span class="n">a90005c</span> <span class="mf">28000000</span> <span class="mf">00000000</span> <span class="mf">5</span><span class="n">c000000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<p>Above we see that byte 17 &amp; mask 0x08 is false.  So something is up.  Byte 19 [0x5c] happens to represent the number of bytes in the response packet.  Interesting...</p>
<div class="highlight"><pre><span></span><code><span class="mf">521267</span>  <span class="n">dest</span><span class="o">=</span><span class="n">WINDOZE</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x15</span><span class="p">,</span> <span class="n">write_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">CAMERA</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000172e6380</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x005c</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">10000020</span> <span class="mf">42000000</span> <span class="mf">02000000</span> <span class="mf">1</span><span class="n">d001022</span>
 <span class="mf">42000000</span> <span class="mf">7</span><span class="n">ced2501</span> <span class="mf">00000000</span> <span class="mf">2</span><span class="n">e000100</span>
 <span class="mf">00010002</span> <span class="mf">00030004</span> <span class="mf">00050006</span> <span class="mf">00070008</span>
 <span class="mf">0009000</span><span class="n">a</span> <span class="mf">000</span><span class="n">b000c</span> <span class="mf">000</span><span class="n">d000e</span> <span class="mf">000</span><span class="n">f0010</span>
 <span class="mf">00110012</span> <span class="mf">00130014</span> <span class="mf">00150200</span> <span class="n">ff0100ff</span>
 <span class="mf">0200</span><span class="n">ff01</span> <span class="mf">05</span><span class="n">ff0200</span> <span class="n">ff0106ff</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<p>What's interesting is that the middle of the packet counts from 0x0001 to 0x0015 in 16-bit words.  Then after that there appear to be six 3-byte strings: 0x0200ff, 0x0100ff, 0x0200ff, 0x0105ff, 0x0106ff.</p>
<hr>
<p>Okay I'm pretty interested in this 0x5c thing.  That is a magic number that I remember from the gphoto2 Canon USB driver.  0x5c is the number of bytes in a 'release params' data structure from the camera.  Release params are things like shutter speed, ISO, etc.  Let's look at the gphoto2 usb source and see if anything matches up.   I think this picture was captured at ISO 640... (looks at camlibs/canon source) ... let's see, for the EOS 5D, that would be a value of 0x5d, offset 0x1a bytes into the packet .... doh, doesn't match.  false alarm...  XXX Turns out this is because I'm looking in the wrong place!  See below!</p>
<hr>
<p>Camera idle loop:</p>
<p>This sequence occurs every second under Windows.  0xffc3 is WINDOZE, 0xffc0 is CAMERA.</p>
<div class="highlight"><pre><span></span><code><span class="mf">363034</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x2a</span><span class="p">,</span> <span class="n">write_quadlet_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">xfffff0010810</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000000f</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">363064</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x2a</span><span class="p">,</span> <span class="n">write_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">363090</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60d0</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">363117</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">00000000</span> <span class="mf">04</span><span class="n">da60a8</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">363762</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60a8</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">363788</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="n">ffffffff</span> <span class="n">ffffffff</span> <span class="n">ffc30000</span> <span class="mf">0</span><span class="n">cf5ed20</span>
 <span class="mf">8</span><span class="n">a900054</span> <span class="mf">03000000</span> <span class="mf">54000000</span> <span class="mf">00000000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">364702</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x16</span><span class="p">,</span> <span class="n">write_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x00000cf5ed20</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0054</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">70000900</span> <span class="mf">00000058</span> <span class="mf">00000000</span> <span class="mf">80000000</span>
 <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span>
 <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span>
 <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span>
 <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span>
 <span class="mf">00000000</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">365127</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x0b</span><span class="p">,</span> <span class="n">write_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000900000020</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">41000000</span> <span class="mf">04</span><span class="n">da60a8</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<hr>
<p><strong>Aha! Byte diff for an F-stop setting change</strong></p>
<div class="highlight"><pre><span></span><code><span class="mf">325342</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x09</span><span class="p">,</span> <span class="n">write_quadlet_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">xfffff0010810</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000000f</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">325368</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x09</span><span class="p">,</span> <span class="n">write_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">325393</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60a8</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">325419</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">00000000</span> <span class="mf">04</span><span class="n">da60d0</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">325751</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60d0</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">325780</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="n">ffffffff</span> <span class="n">ffffffff</span> <span class="n">ffc30000</span> <span class="mf">0775</span><span class="n">f480</span>
 <span class="mf">8</span><span class="n">a900054</span> <span class="mf">28000000</span> <span class="mf">00000000</span> <span class="mf">54000000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">343041</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x15</span><span class="p">,</span> <span class="n">write_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x00000775f480</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0054</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">10000020</span> <span class="mf">4</span><span class="n">c000000</span> <span class="mf">02000000</span> <span class="mf">25001022</span>
 <span class="mf">4</span><span class="n">c000000</span> <span class="mf">38</span><span class="n">e92501</span> <span class="mf">00000000</span> <span class="mf">0</span><span class="n">a000000</span>
 <span class="mf">30000000</span> <span class="mf">20</span><span class="n">ff0100</span> <span class="mf">0000</span><span class="n">ffff</span> <span class="mf">04010000</span>
 <span class="mf">03020000</span> <span class="mf">09030000</span> <span class="mf">007</span><span class="n">f7f7f</span> <span class="mf">70005800</span>
 <span class="mf">2</span><span class="n">d007800</span> <span class="mf">0000</span><span class="n">ff00</span> <span class="mf">20005800</span> <span class="mf">64006400</span>
 <span class="mf">64000100</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<p>Take a look at byte 64 [0x2d] in the above packet.  That was with one particular aperture setting -- not sure if it's 4.5 or 5.0.  Diffing this against traffic from changing the wheel back changed byte 64 to 0x2b.  Woo hoo!</p>
<hr>
<p>One other thing from that last aperture wheel setting change.  How did the computer know that the camera settings had changed, and that it should query them?  Take a look at the write_block_request in the idle loop packets above.  Then check this out (scroll down to the write_block_request pkt):</p>
<div class="highlight"><pre><span></span><code><span class="mf">289212</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x05</span><span class="p">,</span> <span class="n">write_quadlet_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">xfffff0010810</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000000f</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">289242</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x05</span><span class="p">,</span> <span class="n">write_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">289269</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60a8</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">289296</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x38</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0008</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">00000000</span> <span class="mf">04</span><span class="n">da60d0</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">289881</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x000004da60d0</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="n">ack_pending</span>
<span class="mf">289908</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x39</span><span class="p">,</span> <span class="kr">read</span><span class="n">_block_response</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0020</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="n">ffffffff</span> <span class="n">ffffffff</span> <span class="n">ffc30000</span> <span class="mf">0</span><span class="n">cf5ed20</span>
 <span class="mf">8</span><span class="n">a900054</span> <span class="mf">03000000</span> <span class="mf">54000000</span> <span class="mf">00000000</span>

<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
<span class="mf">290452</span>  <span class="n">dest</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc3</span><span class="p">,</span> <span class="n">tl</span><span class="o">=</span><span class="mf">0</span><span class="n">x11</span><span class="p">,</span> <span class="n">write_block_request</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mf">0</span><span class="n">xffc0</span><span class="p">,</span> <span class="n">offs</span><span class="o">=</span><span class="mf">0</span><span class="n">x00000cf5ed20</span><span class="p">,</span> <span class="kd">data</span><span class="n">_length</span><span class="o">=</span><span class="mf">0</span><span class="n">x0054</span><span class="p">,</span> <span class="n">extended_tcode</span><span class="o">=</span><span class="mf">0</span><span class="n">x0000</span><span class="p">,</span> <span class="kd">data</span><span class="o">=</span><span class="err">[</span>
 <span class="mf">70000900</span> <span class="mf">00000058</span> <span class="mf">00000000</span> <span class="mf">80000000</span>
 <span class="mf">00000000</span> <span class="mf">02000000</span> <span class="mf">0</span><span class="n">a000000</span> <span class="mf">10000000</span>
 <span class="mf">1</span><span class="n">b000000</span> <span class="mf">00000000</span> <span class="mf">00000000</span> <span class="mf">00845400</span>
 <span class="n">f4ff9500</span> <span class="n">d17b4100</span> <span class="mf">0</span><span class="n">f05ffff</span> <span class="n">ffff0106</span>
 <span class="n">ffffffff</span> <span class="mf">0102</span><span class="n">ffff</span> <span class="n">ffff0200</span> <span class="n">ff0100ff</span>
 <span class="mf">0200</span><span class="n">ff01</span>
<span class="err">]</span><span class="p">,</span> <span class="n">ack_complete</span>
</code></pre></div>

<p>See all that junk at the end?  I think that's how the computer knows to follow up queries.</p>
<hr>
<p>Okay, just changed ISO and did the same thing as the aperture thing.  Changed ISO 250 to 320.  Byte 66 changed to 0x7b.  Changed back.  Byte 66 changed to 0x78.  Those two values match exactly with the shutter speed table in gphoto2 camlibs/canon.  Shutter speed offset is 0x1e, and aperture offset is 0x1c in the gphoto USB code; this seems to jive with those defines if we consider the 'start' of the release params payload to start at byte 36 of the packet.</p>
<p>It's interesting that the capture.log.txt that we took has 0xff for both of these parameters.  Perhaps that is because we took those shots in full-auto mode?</p>
<p>Anyway, it looks like the magic hex string to search for to find get-release-param commands is '8a900054 28'.</p>
<hr>
<p><strong>libraw1394</strong></p>
<p>I'll bet this is what we'd need to use to start testing these commands out: <a href="http://www.linux1394.org/doc/libraw1394/">http://www.linux1394.org/doc/libraw1394/</a></p>
<p>XXX On the other hand, if this device really just speaks SCSI, then we don't need libraw1394 at all..</p>
<hr>
<h2>Arrrr!</h2>
<p><img alt="paul_and_raj_r0xx0rs" src="/images/paul_and_raj_r0xx0rs.jpg"></p>
<hr>
<h2>2007 Aug 24: SBP and SCSI and Wireshark oh my</h2>
<p><strong>SCSI and SBP2</strong></p>
<p>So today Raj and shag had an interesting thought.  We noticed that when we plugged in the camera to our Linux box that <a href="http://t10.org/ftp/t10/drafts/sbp2/sbp2r04.pdf">SBP-2</a> kicked in and the SCSI layer identified the camera and decided it was a scanner (at least in terms of SCSI).  This made us think, "Selves, what if we nosy'd the Linux-&gt;camera communication upon initial plugin and compared that the communication on the Windows side to see if that was using SBP-2 also?"  So we did.  And guess what?  We found a lot of similar packets!  So now we think that the Canon software is just sending down SCSI commands over SBP-2 over Firewire to get the camera to do things.</p>
<p>So then the question became, well, how do we snoop SCSI?  And it turns out that we could not find any SCSI snoopers that were not hardware based and therefore cost a gazillion dollars and probably did not have any Firewire ports on them anyway.  ... at least until we discovered that Wireshark nee Ethereal had an interesting thingamabob called packet-scsi.c written by some dude at Cicsoc who probably got paid to write that thing for iSCSI.  but maybe we can use that too!!! all wee need to do is to write something where Wireshark can load up nosy-dump files, then we need to write a dissector thingie for SBP-2 (since that does not appear to exist).  Then in the best of all possible worlds, packet-scsi would then magically parse all of the data.</p>
<p>yeah.</p>
<hr>
<p>So we think we'll also probably have to write a basic Firewire -- really, a nosy-dump file format -- dissector.  The traces we've read look pretty simple so far in terms of commands - there aren't any isochronous transfers, all we should need are:</p>
<ul>
<li>self id</li>
<li>bus reset</li>
<li>{read,write}<em _response=",response">{quadlet,block}</em></li>
</ul>
<p>looks like we can pull the format right out of the nosy-dump.c source code, <a href="http://bitplanet.net/">krh's</a> structs are really nicely formatted and this should be straightforward.</p>
<ul>
<li>Wireshark Developer's Guide: <a href="http://www.wireshark.org/download/docs/developer-guide-us.pdf">PDF</a></li>
</ul>
<hr>
<p>So to write a new file format importer for Wireshark, one must modify this library that comes with it called Wiretap.  unfortunately the current format of nosy-dump files doesn't have any magic numbers that can be used to identify them, so probably the best thing to do is to prepend some magic number/string with an external tool, and modify nosy-dump to prepend these itself for future revs.</p>
<h2>2007 Nov 1: nosy-dump file format</h2>
<p>So the current rev of nosy-dump has a really simple file format: PASCAL strings (basically).  It writes exactly what nosy-dump receives from the kernel: an int, representing the number of bytes to follow, and then writes the bytes.</p>
<p><strong>Hack libpcap instead</strong></p>
<p>Probably the best thing to do is to hack FireWire sniffing support into libpcap.  libpcap already has Bluetooth and USB sniffing support in it...</p>
<h2>2007 Late November: adding FireWire support to Wireshark</h2>
<p>Shelved the libpcap idea for the time being.  Wrote a basic nosydump wiretap reader, and hacked up basic Firewire phy &amp; link protocol dissectors to Wireshark.  Next step is to hack up something for SBP2.</p>
<p><img alt="wireshark" src="/images/wireshark1.jpg"></p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://raj.blog.archive.org">raj.blog.archive.org</a></li>
                            <li><a href="http://tikirobot.net">TikiRobot</a></li>
                            <li><a href="/archives.html">Archives</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://github.com/rajbot">github</a></li>
                            <li><a href="http://twitter.com/rajbot">twitter</a></li>
                            <li><a href="mailto:raj@bitstreamFIXME.eyeoh">email</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->


</body>
</html>